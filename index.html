<!DOCTYPE html>
<html lang="ja"> 
<head>
    <meta charset="UTF-8" />
    <title>AHC Statistics</title> <style>
        body { font-family: sans-serif; font-size: 14px; }
        .error { color: red; }
        pre {
          background: #f5f5f5;
          padding: 10px;
          border-radius: 6px;
          overflow-x: auto;
          margin: 0;
        }
        code {
          font-family: monospace;
        }
        .code-block {
          position: relative;
          background: #f5f5f5;
          padding: 10px;
          border-radius: 6px;
          overflow-x: auto;
          margin-bottom: 20px;
          margin: 0;
        }

        .code-label {
          position: absolute;
          top: 0;
          right: 0;
          background: #333;
          color: white;
          font-size: 0.75em;
          padding: 2px 6px;
          border-bottom-left-radius: 4px;
        }

        .summary {
          background: #f5f5f5;
        }
        .summary:hover {
            background: #eee;
        }

        .container{
            display: flex;
        }
        .setting {
            flex: 1;
            width: 15vw ;
            height: 80vh;
            font-size: 20px ;
            background: #ebfafc ;
        }
        .div2 {
            flex: 3 ;
        }
        .setting .choices {
            width: 100%;       /* 親幅にフィットさせる */
            max-width: 100%;
            box-sizing: border-box; /* padding/border込みで幅を計算 */
        }
        .setting .choices__inner {
            width: 100%;
            box-sizing: border-box;
            display: block;     /* inline-block だと縮むので block に */
        }
        .setting .file {
            font-size: 1rem;
        }
        .setting .Mode {
            font-size: 1rem;
        }


    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
    <h1>AHC Statistics</h1>

    <!--discription-->
    <details class = "detail">
        <summary class = "summary">description</summary>
        AHCでテストケースを何ケースか実行した後のエラー出力の入ったフォルダ(公式ツールではtools/err)を読み込むと、それぞれのファイル中の"a:3"のような形を数値として読み取りグラフにしてくれます。
        <div></div>例えばerrというフォルダに0000.txt 0001.txt 0002.txt があり
        <div class="code-block"><div class="code-label">0000.txt</div><pre><code>a:4
b:2</code></pre></div>
と
        <div class="code-block"><div class="code-label">0001.txt</div><pre><code>a:3
b:3</code></pre></div>
 と       <div class="code-block"><div class="code-label">0002.txt</div><pre><code>a:2
b:4</code></pre></div>
        とありPlot Dotsモードでvar1に"a"、var2に"b"と入力すると、散布図として(2,4) (3,3) (4,2) がプロットされます。
        <br><br>
        <div class="code-block"><div class="code-label">0000.txt</div><pre><code>list:3 2 1</code></pre></div>
と
<div class="code-block"><div class="code-label">0002.txt</div><pre><code>list:1 2 3</code></pre></div>
        とありListモードでcasenameに"0 2"、listnameに"list"と入力すると、折れ線グラフとして(3,2,1) (1,2,3) がプロットされます。
    </details>
    <br>

    <!--inputs-->
    <div class = "container">
        <div id = "setting" class = "setting">
            <label for="Mode">Mode : </label>
            <select id="Mode" name="Mode" class="Mode">
                <option value="Plot Dots">Plot Dots</option>
                <option value="List">List</option>
            </select>
            <br><br>
            
            <input type="file" id="err_folder" webkitdirectory multiple style="display:none;">
            <button id="addFolder" class = "file">フォルダ追加</button>
            <div id="folderList"></div>
            
            <br>
            <label id="labvar1" for="vars">var 1 : </label>
            <select type="text" id="var1" name="var1" class = "choices"></select>
            <label id="labvar2" for="vars">var 2 : </label>
            <select type="text" id="var2" name="var2" class = "choices"></select>
            
            <label id="labcase" for="vars">Case : </label>
            <input type="text" id="casename" name="casename">
            <label id="lablist" for="vars">List : </label>
            <input type="text" id="listname" name="listname">
        </div>
        <br>
        <div class = "div2">
            <div class="error" id="error">Select a folder</div>
            <canvas id="chart" width="600" height="230"></canvas>
        </div>
    </div>


    <script>
        let choicesVar1, choicesVar2;
        
        window.addEventListener('DOMContentLoaded', () => {
            choicesVar1 = new Choices('#var1', {
                removeItemButton: true,
                searchEnabled: true,
                placeholderValue: 'Select var1...',
            });
        
            choicesVar2 = new Choices('#var2', {
                removeItemButton: true,
                searchEnabled: true,
                placeholderValue: 'Select var2...',
            });
        });

        
        const Mode = document.getElementById('Mode');
        const var1 = document.getElementById('var1');
        const var2 = document.getElementById('var2');
        const casename = document.getElementById('casename');
        const listname = document.getElementById('listname');
        const labvar1 = document.getElementById('labvar1');
        const labvar2 = document.getElementById('labvar2');
        const labcase = document.getElementById('labcase');
        const lablist = document.getElementById('lablist');
        const ctx = document.getElementById('chart').getContext('2d');
        
        const folderInput = document.getElementById("err_folder");
        const addFolderBtn = document.getElementById("addFolder");
        const folderListDiv = document.getElementById("folderList");

        function error(context) {
            document.getElementById('error').innerHTML = context ;
        }
        
        Mode.onchange = (e) => {
            if (Mode.value == "Plot Dots") {
                labvar1.style.display = "inline";
                labvar2.style.display = "inline";
                var1.style.display = "inline";
                var2.style.display = "inline";
                labcase.style.display = "none";
                lablist.style.display = "none";
                casename.style.display = "none";
                listname.style.display = "none";
            }
            else {
                labvar1.style.display = "none";
                labvar2.style.display = "none";
                var1.style.display = "none";
                var2.style.display = "none";
                labcase.style.display = "inline";
                lablist.style.display = "inline";
                casename.style.display = "inline";
                listname.style.display = "inline";
            }
            UpdateGraph();
        }
        Mode.onchange();
        var variables_data = {};
        function randomColor(){
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgb(${r},${g},${b})`;
        }
        
        addFolderBtn.onclick = () => {
            folderInput.value = "";
            folderInput.click();
        };
        
        folderInput.onchange = async (e) => {
            const folderName = window.prompt("フォルダ名を入力してください。","folder" + String(Object.keys(variables_data).length + 1));
            if (!folderName) {
                error("Enter a folder name.");
                return;
            }
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            //txtかどうか
            for (const file of files) {
                if (!file.name.endsWith(".txt")) {
                    error(`Invalid file type: ${file.name}. Only .txt files are allowed.`);
                    return;
                }
            }
        
            const results = await Promise.all(files.map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve(ev.target.result);
                    reader.readAsText(file);
                });
            }));
        
            let variables = {};
            variables["#"] = [];
            for (let fileIndex = 0; fileIndex < results.length; fileIndex++) {
                const text = results[fileIndex];
                variables["#"].push(fileIndex);
        
                const lines = text.split(/\r\n|\r|\n/);
                for (let line of lines) {
                    let splcoron = line.trim().split(":");
                    if (splcoron.length != 2) continue;
                    let name = splcoron[0].trim();
                    if (!variables[name]) variables[name] = [];
                    let values = splcoron[1].trim().split(" ").map(Number);
                    if (values.length == 1) {
                        variables[name].push(values[0]);
                    } else {
                        variables[name].push(values);
                    }
                }
            }
        
            variables_data[folderName] = variables;
        
            renderFolderCheckboxes();

            updateElementofVars() ;
            
            UpdateGraph();
        };
        
        function renderFolderCheckboxes() {
            folderListDiv.innerHTML = "";
            for (let fname in variables_data) {
                const id = "chk_" + fname;
                const div = document.createElement("div");
                div.innerHTML = `
                    <input type="checkbox" id="${id}" checked>
                    <label for="${id}">${fname}</label>
                `;
                folderListDiv.appendChild(div);
        
                document.getElementById(id).addEventListener("change", UpdateGraph);
            }
        }
        function updateElementofVars() {
            var tmp1 = var1.value ;
            var tmp2 = var2.value ;
            var variableNameList = new Set();
        
            for (let fname in variables_data) {
                for (let key of Object.keys(variables_data[fname])) {
                    variableNameList.add(key);
                }
            }
            variableNameList = Array.from(variableNameList) ;

            if (!tmp1) tmp1 = variableNameList[0] ;
            if (!tmp2) tmp2 = variableNameList[0] ;
            
            const items = [...variableNameList].map(v => ({ value: v, label: v }));
        
            choicesVar1.clearStore();
            choicesVar1.setChoices(items, 'value', 'label', true);
            choicesVar1.setChoiceByValue(tmp1) ;
        
            choicesVar2.clearStore();
            choicesVar2.setChoices(items, 'value', 'label', true);
            choicesVar2.setChoiceByValue(tmp2) ;

        }


        var1.onchange = function() {
            UpdateGraph();
        }
        var2.onchange = function() {
            UpdateGraph();
        }
        casename.onchange = function() {
            UpdateGraph();
        }
        listname.onchange = function() {
            UpdateGraph();
        }

        function UpdateGraph() {
            if (Mode.value == "Plot Dots") {
                PlotDots(var1.value, var2.value);
            } else {
                PlotList(casename.value.trim().split(" "), listname.value);
            }
        }
        
        function PlotDots(var1, var2) {
            if (window.myScatter) window.myScatter.destroy();
            if (window.myLine) window.myLine.destroy();
            if (!var1 && !var2) {
                error("var1 and var2 are required.") ;
                return ;
            }
            if (!var1) {
                error("var1 is required.") ;
                return ;
            }
            if (!var2) {
                error("var2 is required.") ;
                return ;
            }
        
            let datasets = [];
            for (let fname in variables_data) {
                const chk = document.getElementById("chk_" + fname);
                if (!chk || !chk.checked) continue;
        
                const variables = variables_data[fname];
                if (!variables[var1]){
                    error('No such variable : "' + String(var1) + '".') ;
                    return ;
                }
                if (!variables[var2]){
                    error('No such variable : "' + String(var2) + '".') ;
                    return ;
                }
                if (variables[var1].length != variables[var2].length){
                    error(`Length of '${var1}' and '${var2}' do not match.`);
                    return ;
                }
        
                datasets.push({
                    label: `${fname}: ${var1} vs ${var2}`,
                    data: variables[var1].map((x, i) => ({x: x, y: variables[var2][i]})),
                    backgroundColor: randomColor(),
                    radius: 4
                });
            }
        
            if (datasets.length == 0) {
                error("No valid dataset");
                return;
            }
            error("");
        
            window.myScatter = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: { responsive: true }
            });
        }
        
        function PlotList(cases, listName) {
            if (window.myLine) window.myLine.destroy();
            if (window.myScatter) window.myScatter.destroy();
            if (!listName) {
                error("listName is required.") ;
                return ;
            }
        
            let datasets = [];
            for (let fname in variables_data) {
                const chk = document.getElementById("chk_" + fname);
                if (!chk || !chk.checked) continue;
        
                var variables = variables_data[fname];
                if (!variables[listName]){
                    error('No such variable : "' + String(listName) + '".') ;
                    return ;
                }
                if (variables[listName].length == 1) {
                    variables[listName] = [variables[listName]] ;
                }
        
                const allSeries = [];
                for (let x of cases) {
                    if (variables[listName].length <= x || x < 0) continue;
                    allSeries.push(variables[listName][x]);
                }
        
                for (let idx=0; idx<allSeries.length; idx++) {
                    datasets.push({
                        label: `${fname} Case ${cases[idx]}`,
                        data: allSeries[idx],
                        borderColor: randomColor(),
                        fill: false,
                        lineTension: 0
                    });
                }
            }
        
            if (datasets.length == 0) {
                error("No valid dataset");
                return;
            }
            error("");
        
            window.myLine = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datasets[0].data.map((_, i) => i+1),
                    datasets
                },
                options: { responsive: true }
            });
        }


    </script>
</body>
</html>
