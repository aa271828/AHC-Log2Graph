<!DOCTYPE html>
<html lang="ja"> 
<head>
    <meta charset="UTF-8" />
    <title>AHC Log2Graph</title> <style>
        body {
            font-family: sans-serif;
            font-size: 14px;
            overflow: hidden;
        }
        .title {
            font-size: 2em ;
            border: 1px solid #eee;
        }
        .error { color: red; }
        pre {
          background: #f5f5f5;
          padding: 10px;
          border-radius: 6px;
          overflow-x: auto;
          margin: 0;
        }

        .container{
            display: flex;
            flex-direction: row;
            height: 87vh;
        }
        .setting {
            position: relative;
            flex: 1;
            width: 15vw ;
            font-size: 20px ;
            background: #ebfafc ;
            border: 1px solid #ccc;
        }
        .div2 {
            flex: 3 ;
        }
        /*そのままだとchoices.jsのやつが切れる*/
        .setting .choices__inner {
            box-sizing: border-box;
        }
        .setting .tab-menu {
            width: 96%;
            padding: 0;
            margin: 3px auto;
            list-style: none;
            display: flex;
            gap: 10px;
        }
        .setting .tab-menu li {
            flex: 1;
            text-align: center;
            font-size: 1.3rem;
            padding: 0.5em 1em;
            background: #fff;
            color: #0D47A1;
            border: 1px solid #007bee;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .setting .tab-menu li:hover {
            background: #bbdefb;
        }
        
        .setting .tab-menu li.active {
            background-color: #007bee;
            color: white;
        }
        .setting .file {
            font-size: 1.1rem;
            padding: 0.5em 1em;
            border: 1px solid #90CAF9;
            background: #E3F2FD;
            width: 100%;
            color: #0D47A1;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .setting .file:hover {
            background: #bbdefb;
        }

        .setting .folderList {
            background: #f5f5f5;
            height: 150px ;
            padding: 0.5em 1em;
            border: 1px solid #ccc;
            background: #eee;
            border-radius: 6px;
            overflow-y: auto;
        }

        .setting .folderList input {
            transform: scale(1.5);
            accent-color: #0096c7;
        }

        .setting .line {
            font-size: 1rem;
            padding: 0.5em 1em;
            border: 1px solid #90CAF9;
            background: #E3F2FD;
            color: #0D47A1;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .setting .line:hover {
            background: #bbdefb;
        }
        .setting .line-checkbox {
            width: 0px;
            height: 0px;
            opacity: 0;
        }
        .setting .line:has(input:checked) {
            background-color: #007bee;
            color: #fff;
        }

        .inputbox {
            background-color: #f9f9f9;
            width: 100%;
            box-sizing: border-box;
            margin: 0 auto;
            height: 40px;
        }

        

    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
    <input value = "AHC Log2Graph" class = "title">

    <div class = "container">
        <!--inputs-->
        <div id = "setting" class = "setting">
            <ul class = "tab-menu">
                <li data-mode="Plot Dots" class="active">Scatter plot</li>
                <li data-mode="List">List</li>
            </ul>
            <br>
            
            <input type="file" id="err_folder" webkitdirectory multiple style="display:none;">
            <button id="addFolder" class = "file">Load log files</button>
            <br><br>
            <div id="folderList" class = "folderList"></div>
            
            <br>
            <div id = "mode1">
                <select type="text" id="var1" name="var1" class = "choices"></select>
                <select type="text" id="var2" name="var2" class = "choices"></select>
                <label class="line"><input type="checkbox" id = "line" class = "line-checkbox">Show line</label>
            </div>
            <div id = "mode2">
                <input type="text" id="casename" name="casename" class = "inputbox" placeholder = "0 1 2...">
                <br><br>
                <select type="text" id="listname" name="listname" class = "choices"></select>
            </div>
        </div>
        <br>
        <div class = "div2">
            <div class="error" id="error">Select a folder</div>
            <canvas id="chart" width="600" height="230"></canvas>
        </div>
    </div>


    <script>
        let choicesVar1, choicesVar2, choicesListname ;
        
        window.addEventListener('DOMContentLoaded', () => {
            choicesVar1 = new Choices('#var1', {
                removeItemButton: true,
                searchEnabled: true,
                placeholderValue: 'x-axis...',
            });
        
            choicesVar2 = new Choices('#var2', {
                removeItemButton: true,
                searchEnabled: true,
                placeholderValue: 'y-axis...',
            });
            choicesListname = new Choices('#listname', {
                removeItemButton: true,
                searchEnabled: true,
                placeholderValue: 'list...',
            });
        });

        var mode = "Plot Dots" ;
        
        const var1 = document.getElementById('var1');
        const var2 = document.getElementById('var2');
        const casename = document.getElementById('casename');
        const listname = document.getElementById('listname');
        const ctx = document.getElementById('chart').getContext('2d');
        
        const folderInput = document.getElementById("err_folder");
        const addFolderBtn = document.getElementById("addFolder");
        const folderListDiv = document.getElementById("folderList");

        function error(context) {
            document.getElementById('error').innerHTML = context ;
        }

        const tabs = document.querySelectorAll('.setting .tab-menu li');

        tabs.forEach((tab , index) => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active')) ;
                tab.classList.add('active') ;
                mode = tab.dataset.mode ;
                modeChange() ;
            });
        });
        
        function modeChange() {
            if (mode == "Plot Dots") {
                document.getElementById("mode1").style.display = "inline";
                document.getElementById("mode2").style.display = "none" ;
            }
            else {
                document.getElementById("mode1").style.display = "none";
                document.getElementById("mode2").style.display = "inline" ;
            }
            UpdateGraph();
        }
        modeChange() ;
        var variables_data = {};
        function randomColor(){
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgb(${r},${g},${b})`;
        }
        
        addFolderBtn.onclick = () => {
            folderInput.value = "";
            folderInput.click();
        };
        
        folderInput.onchange = async (e) => {
            const folderName = window.prompt("フォルダ名を入力してください。","folder" + String(Object.keys(variables_data).length + 1));
            if (!folderName) {
                error("Enter a folder name.");
                return;
            }
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            //txtかどうか
            for (const file of files) {
                if (!file.name.endsWith(".txt")) {
                    error(`Invalid file type: ${file.name}. Only .txt files are allowed.`);
                    return;
                }
            }
        
            const results = await Promise.all(files.map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = (ev) => resolve(ev.target.result);
                    reader.readAsText(file);
                });
            }));
        
            let variables = {};
            variables["#"] = [];
            for (let fileIndex = 0; fileIndex < results.length; fileIndex++) {
                const text = results[fileIndex];
                variables["#"].push(fileIndex);
        
                const lines = text.split(/\r\n|\r|\n/);
                for (let line of lines) {
                    let splcoron = line.trim().split(":");
                    if (splcoron.length != 2) continue;
                    let name = splcoron[0].trim();
                    if (!variables[name]) variables[name] = [];
                    let values = splcoron[1].trim().split(" ").map(Number);
                    if (values.length == 1) {
                        variables[name].push(values[0]);
                    } else {
                        variables[name].push(values);
                    }
                }
            }
        
            variables_data[folderName] = variables;
        
            renderFolderCheckboxes();

            updateElementofVars() ;
            
            UpdateGraph();
        };
        
        function renderFolderCheckboxes() {
            folderListDiv.innerHTML = "";
            for (let fname in variables_data) {
                const id = "chk_" + fname;
                const div = document.createElement("div");
                div.innerHTML = `
                    <label for="${id}"><input type="checkbox" id="${id}" checked> ${fname}</label>
`;
                folderListDiv.appendChild(div);
        
                document.getElementById(id).addEventListener("change", UpdateGraph);
            }
        }
        function updateElementofVars() {
            var tmp1 = var1.value ;
            var tmp2 = var2.value ;
            var tmp3 = listname.value ;
            var variableNameList = new Set();
        
            for (let fname in variables_data) {
                for (let key of Object.keys(variables_data[fname])) {
                    variableNameList.add(key);
                }
            }
            variableNameList = Array.from(variableNameList) ;

            if (!tmp1) tmp1 = variableNameList[0] ;
            if (!tmp2) tmp2 = variableNameList[0] ;
            
            const items = [...variableNameList].map(v => ({ value: v, label: v }));
        
            choicesVar1.clearStore();
            choicesVar1.setChoices(items, 'value', 'label', true);
            choicesVar1.setChoiceByValue(tmp1) ;
        
            choicesVar2.clearStore();
            choicesVar2.setChoices(items, 'value', 'label', true);
            choicesVar2.setChoiceByValue(tmp2) ;

            choicesListname.clearStore();
            choicesListname.setChoices(items, 'value', 'label', true);
            choicesListname.setChoiceByValue(tmp3) ;

        }


        var1.onchange = function() {
            UpdateGraph();
        }
        var2.onchange = function() {
            UpdateGraph();
        }
        casename.onchange = function() {
            UpdateGraph();
        }
        listname.onchange = function() {
            UpdateGraph();
        }
        document.getElementById("line").onchange = function() {
            UpdateGraph();
        }

        function UpdateGraph() {
            if (mode == "Plot Dots") {
                PlotDots(var1.value, var2.value);
            } else {
                PlotList(casename.value.trim().split(" "), listname.value);
            }
        }
        
        function PlotDots(var1, var2) {
            if (window.myScatter) window.myScatter.destroy();
            if (window.myLine) window.myLine.destroy();
            if (!var1 || !var2) {
                error ("Please select variables.") ;
                return ;
            }
        
            let datasets = [];
            for (let fname in variables_data) {
                const chk = document.getElementById("chk_" + fname);
                if (!chk || !chk.checked) continue;
        
                const variables = variables_data[fname];
                if (!variables[var1]){
                    error('No such variable : "' + String(var1) + '".') ;
                    return ;
                }
                if (!variables[var2]){
                    error('No such variable : "' + String(var2) + '".') ;
                    return ;
                }
                if (variables[var1].length != variables[var2].length){
                    error(`Length of '${var1}' and '${var2}' do not match.`);
                    return ;
                }

                let ranc = randomColor() ;
                datasets.push({
                    label: `${fname}: ${var1} vs ${var2}`,
                    data: variables[var1].map((x, i) => ({x: x, y: variables[var2][i]})),
                    backgroundColor: ranc,
                    radius: 4,
                    showLine: document.getElementById("line").checked,
                    borderColor: ranc,
                    fill: false,
                });
            }
        
            if (datasets.length == 0) {
                error("No data available to plot.");
                return;
            }
            error("");
        
            window.myScatter = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: { responsive: true }
            });
        }
        
        function PlotList(cases, listName) {
            if (window.myLine) window.myLine.destroy();
            if (window.myScatter) window.myScatter.destroy();
            if (!listName) {
                error("Please select a list variable.") ;
                return ;
            }
        
            let datasets = [];
            for (let fname in variables_data) {
                const chk = document.getElementById("chk_" + fname);
                if (!chk || !chk.checked) continue;
        
                var variables = variables_data[fname];
                if (!variables[listName]){
                    error('No such variable : "' + String(listName) + '".') ;
                    return ;
                }
                if (variables[listName].length == 1) {
                    variables[listName] = [variables[listName]] ;
                }
        
                const allSeries = [];
                for (let x of cases) {
                    if (variables[listName].length <= x || x < 0) continue;
                    allSeries.push(variables[listName][x]);
                }
        
                for (let idx=0; idx<allSeries.length; idx++) {
                    datasets.push({
                        label: `${fname} Case ${cases[idx]}`,
                        data: allSeries[idx],
                        borderColor: randomColor(),
                        fill: false,
                        lineTension: 0
                    });
                }
            }
        
            if (datasets.length == 0) {
                error("No data available to plot.");
                return;
            }
            error("");
        
            window.myLine = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: datasets[0].data.map((_, i) => i+1),
                    datasets
                },
                options: { responsive: true }
            });
        }


    </script>
</body>
</html>
